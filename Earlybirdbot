import discord
from discord.ext import commands, tasks
from datetime import datetime, timedelta, time
import json
import os
from tokens import etoken, echid, rchid  # âœ… tokens.pyì—ì„œ jtoknì„ ë¶ˆëŸ¬ì˜´

# ğŸ”¹ ë””ìŠ¤ì½”ë“œ ë´‡ í† í° (tokens.pyì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
TOKEN = etoken  # âœ… ë¶ˆëŸ¬ì˜¨ í† í°ì„ ì‚¬ìš©
WAKEUP_CHANNEL_ID = echid
RANK_CHANNEL_ID = rchid


# ğŸ”¹ ì±„ë„ ID ì„¤ì • (ë””ìŠ¤ì½”ë“œ ì„œë²„ì—ì„œ ì±„ë„ ìš°í´ë¦­ â†’ "ID ë³µì‚¬" í›„ ì…ë ¥)
WAKEUP_CHANNEL_ID = 1342855016125300856  # ê¸°ìƒ ì±„ë„ ID
RANK_CHANNEL_ID = 1342854960064495678  # ìˆœìœ„ ê³µì§€ ì±„ë„

# ğŸ”¹ JSON íŒŒì¼ ê²½ë¡œ
DATA_FILE = "wakeup_data.json"

# ğŸ”¹ ë´‡ ì„¤ì •
intents = discord.Intents.default()
intents.messages = True
intents.guilds = True
intents.message_content = True

bot = commands.Bot(command_prefix="!", intents=intents)

# ğŸ“Œ JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° & ì €ì¥í•˜ê¸°
def load_data():
    if not os.path.exists(DATA_FILE):
        return {"users": {}, "yesterday_rankings": []}
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

# ğŸ“Œ ê¸°ìƒ ì¸ì¦ (`!ê¸°ìƒ`)
@bot.command(name="ê¸°ìƒ")
async def record_wakeup(ctx):
    if ctx.channel.id != WAKEUP_CHANNEL_ID:
        await ctx.send(f"{ctx.author.mention}, ì´ ëª…ë ¹ì–´ëŠ” ê¸°ìƒ ì±„ë„ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
        return

    user_id = str(ctx.author.id)
    now = datetime.utcnow() + timedelta(hours=9)  # í•œêµ­ ì‹œê°„ ê¸°ì¤€

    data = load_data()
    data["users"][user_id] = now.strftime("%H:%M:%S")  # ê¸°ìƒ ì‹œê°„ ê¸°ë¡ (ë§ˆì§€ë§‰ ì…ë ¥ë§Œ ì €ì¥)

    save_data(data)
    await ctx.send(f"{ctx.author.mention}, ê¸°ìƒ ì‹œê°„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ({now.strftime('%H:%M:%S')})")

# ğŸ“Œ ë§¤ì¼ 8ì‹œ ì–´ì œ ê¸°ìƒ TOP 3 ê³µì§€
@tasks.loop(time=time(8, 0))
async def announce_top_wakeups():
    data = load_data()
    sorted_wakeups = sorted(data["users"].items(), key=lambda x: x[1])[:3]  # ê°€ì¥ ë¹¨ë¦¬ ì¼ì–´ë‚œ 3ëª…

    rank_channel = bot.get_channel(RANK_CHANNEL_ID)
    if sorted_wakeups and rank_channel:
        yesterday = (datetime.utcnow() + timedelta(hours=9) - timedelta(days=1)).strftime("%Y-%m-%d")
        message = f"**ğŸ“¢ {yesterday} ê¸°ìƒ TOP 3!**\n"
        for i, (user_id, wakeup_time) in enumerate(sorted_wakeups, start=1):
            message += f"ğŸ¥‡ {i}ìœ„: <@{user_id}> ({wakeup_time})\n"

        await rank_channel.send(message)

    data["yesterday_rankings"] = sorted_wakeups
    data["users"] = {}  # ë§¤ì¼ ì´ˆê¸°í™”
    save_data(data)

# ğŸ“Œ ë´‡ ì‹¤í–‰
@bot.event
async def on_ready():
    print(f"{bot.user.name} ë´‡ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!")
    announce_top_wakeups.start()

bot.run(TOKEN)
