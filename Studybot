import discord
from discord.ext import commands, tasks
from datetime import datetime, timedelta, time
import json
import os
from tokens import stoken, schid, rchid  # âœ… `tokens.py`ì—ì„œ ê³µë¶€ë´‡ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°

# ğŸ”¹ ë””ìŠ¤ì½”ë“œ ë´‡ í† í°
TOKEN = stoken  # âœ… ê³µë¶€ë´‡ í† í° ì‚¬ìš©

# ğŸ”¹ ì±„ë„ ID ì„¤ì •
STUDY_CHANNEL_ID = schid  # âœ… ê³µë¶€ ì¸ì¦ ì±„ë„ ID
RANK_CHANNEL_ID = rchid  # âœ… ê³µí†µ ìˆœìœ„ ê³µì§€ ì±„ë„ ID

# ğŸ”¹ JSON íŒŒì¼ ê²½ë¡œ
DATA_FILE = "study_data.json"

# ğŸ”¹ ë´‡ ì„¤ì •
intents = discord.Intents.default()
intents.messages = True
intents.guilds = True
intents.message_content = True

bot = commands.Bot(command_prefix="!", intents=intents)

# ğŸ“Œ JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° & ì €ì¥í•˜ê¸°
def load_data():
    if not os.path.exists(DATA_FILE):
        return {"users": {}, "yesterday_rankings": [], "weekly_rankings": []}
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

# ğŸ“Œ ê³µë¶€ ì¸ì¦ (`!ê³µë¶€ HH:MM`)
@bot.command(name="ê³µë¶€", aliases=["study"])
async def record_study(ctx):
    message_content = ctx.message.content[len(ctx.prefix) + len(ctx.invoked_with):].strip()  # "!ê³µë¶€" ë’¤ì˜ ëª¨ë“  ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

    if ctx.channel.id != STUDY_CHANNEL_ID:
        await ctx.send(f"{ctx.author.mention}, ì´ ëª…ë ¹ì–´ëŠ” ê³µë¶€ ì¸ì¦ ì±„ë„ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
        return

    if not message_content or ":" not in message_content:
        await ctx.send(f"{ctx.author.mention}, ê³µë¶€ ì‹œê°„ì„ `HH:MM` í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”! (ì˜ˆ: `!ê³µë¶€ 1:45`)")
        return

    try:
        hours, minutes = map(int, message_content.split(":"))
        if hours < 0 or minutes < 0 or minutes >= 60:
            raise ValueError
    except ValueError:
        await ctx.send(f"{ctx.author.mention}, ì˜ëª»ëœ í˜•ì‹ì…ë‹ˆë‹¤. `HH:MM` í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”! (ì˜ˆ: `!ê³µë¶€ 2:30`)")  
        return

    if not ctx.message.attachments:
        await ctx.send(f"{ctx.author.mention}, ì¸ì¦ ì‚¬ì§„ì„ í•¨ê»˜ ì—…ë¡œë“œí•´ì•¼ ê³µë¶€ ì‹œê°„ì´ ì €ì¥ë©ë‹ˆë‹¤! ğŸ“¸")
        return

    study_time = hours + (minutes / 60)  # ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜
    data = load_data()
    user_id = str(ctx.author.id)

    # ì‚¬ìš©ìì˜ ë§ˆì§€ë§‰ ê³µë¶€ ì‹œê°„ì„ ìƒˆë¡œ ì €ì¥ (ëˆ„ì X)
    data["users"][user_id] = {
        "total_study_time": study_time,
        "weekly_study_time": study_time,
        "photo_count": 1  # ê°€ì¥ ìµœê·¼ ì¸ì¦ë§Œ ë°˜ì˜
    }

    save_data(data)
    await ctx.send(f"{ctx.author.mention}, {hours}ì‹œê°„ {minutes}ë¶„ ê³µë¶€ ì¸ì¦ ì™„ë£Œ! âœ… (ì´ì „ ê¸°ë¡ì€ ë®ì–´ì”Œì›Œì§)")

# ğŸ“Œ ë§¤ì¼ 8ì‹œ ì–´ì œ ê³µë¶€ TOP 3 ê³µì§€
@tasks.loop(time=time(8, 0))
async def announce_daily_ranking():
    data = load_data()
    rankings = sorted(data["users"].items(), key=lambda x: x[1]["total_study_time"], reverse=True)[:3]
    
    rank_channel = bot.get_channel(RANK_CHANNEL_ID)
    if rankings and rank_channel:
        yesterday = (datetime.utcnow() + timedelta(hours=9) - timedelta(days=1)).strftime("%Y-%m-%d")
        message = f"**ğŸ“¢ {yesterday} ê³µë¶€ TOP 3!**\n"
        for i, (user_id, user_data) in enumerate(rankings, start=1):
            message += f"ğŸ¥‡ {i}ìœ„: <@{user_id}> ({user_data['total_study_time']:.2f}ì‹œê°„)\n"
        await rank_channel.send(message)

    data["yesterday_rankings"] = rankings
    for user in data["users"].values():
        user["total_study_time"] = 0
    save_data(data)

# ğŸ“Œ ë§¤ì£¼ ì›”ìš”ì¼ 8ì‹œ ì£¼ê°„ ë­í‚¹ ê³µì§€
@tasks.loop(time=time(8, 0))
async def announce_weekly_ranking():
    if datetime.today().weekday() != 0:  # ì›”ìš”ì¼(0) ì²´í¬
        return

    data = load_data()
    rankings = sorted(data["users"].items(), key=lambda x: x[1]["weekly_study_time"], reverse=True)[:3]
    
    rank_channel = bot.get_channel(RANK_CHANNEL_ID)
    if rankings and rank_channel:
        end_date = (datetime.utcnow() + timedelta(hours=9) - timedelta(days=1)).strftime("%Y-%m-%d")
        start_date = (datetime.utcnow() + timedelta(hours=9) - timedelta(days=7)).strftime("%Y-%m-%d")
        message = f"**ğŸ“¢ {start_date} ~ {end_date} ê³µë¶€ TOP 3! ğŸ¯**\n"
        for i, (user_id, user_data) in enumerate(rankings, start=1):
            message += f"ğŸ¥‡ {i}ìœ„: <@{user_id}> ({user_data['weekly_study_time']:.2f}ì‹œê°„)\n"
        await rank_channel.send(message)

    for user in data["users"].values():
        user["weekly_study_time"] = 0
    save_data(data)

# ğŸ“Œ ë´‡ ì‹¤í–‰
@bot.event
async def on_ready():
    print(f"{bot.user.name} ë´‡ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!")
    announce_daily_ranking.start()
    announce_weekly_ranking.start()

bot.run(TOKEN)
